{{ $contextType := printf "%T" . }}
{{ $isShortcode := (eq $contextType "*hugolib.ShortcodeWithPage") }}

{{
/*
  sectionId: Optional argument to override the default HTML id for this section. If not provided, the default id is used.
  hideViewAll: Optional argument to hide the "View All" button. Set to "true" to hide the button. */
}}
{{ $sectionId := "experience-single" }}
{{ $showViewAll := false }} {{/* 默认设置为false，不显示按钮 */}}
{{ if $isShortcode }}
{{ with .Get "sectionId" }}
{{ $sectionId = . }}
{{ end }}
{{ $hideViewAllParam := .Get "hideViewAll" }}
{{ if eq $hideViewAllParam "true" }}
{{ $showViewAll = false }}
{{ end }}
{{ end }}

<section {{if $sectionId}} id="{{ $sectionId }}" {{end}} class="section-experience section section--border-bottom rad-animation-group flex-grow-1">
    <div class="row flex-column-reverse flex-md-row rad-fade-down">
        <div class="experience-list col-12 col-md-6">
            <h2>
                {{ if $isShortcode }}
                {{ .Get "title" | default "" }}
                {{ else }}
                {{ i18n "experience_title" }}
                {{ end }}
            </h2>

            {{ $xp := where .Site.RegularPages.ByDate "Type" "experience" }}
            {{ if not $isShortcode }}
            {{ $baseLangSite := .Sites.Default }}
            {{ $xp = $xp | lang.Merge (where $baseLangSite.RegularPages.ByDate.Reverse "Type" "experience") }}
            {{ end }}

            {{ $xpCount := len $xp }}
            {{/* in the homepage we limit to the homepageExperienceCount param (6 by default) in the inner page (experience) we display the all */}}
            {{ $totalCount := .Site.Params.homepageExperienceCount | default 2 }}

            {{ if not $isShortcode }}
            {{ if not .IsHome }}
            {{ $totalCount = $xpCount }}
            {{ end }}
            {{ end }}

            {{/* 修复：添加空值检查和参数验证 */}}
            {{ if and $xp (gt (len $xp) 0) }}
            {{ $sortedXp := sort $xp "Date" "desc" }}
            {{ if gt $totalCount 0 }}
            {{ $limitedXp := first $totalCount $sortedXp }}
            {{ range $limitedXp }}
            <div class="experience">
                <a href="{{ .Permalink | relURL }}" class="experience__link">
                    <div class="experience__header">
                        {{ $img := resources.Get .Params.companyLogo }}
                        {{ with $img }}
                        {{ $imgWebp := $img.Resize (printf "%dx%d webp q75 Lanczos picture" $img.Width $img.Height) }}
                        <img src="{{ $imgWebp.RelPermalink }}"
                             alt="{{ .Params.company }} logo"
                             class="experience__company-logo"
                             loading="lazy" />
                        {{ end }}
                        <div class="experience__meta">
                            <div class="experience__date">{{ .Params.duration }}</div>
                            <div class="experience__title">{{ .Params.jobTitle }}</div>
                            <div class="experience__company">
                                {{ .Params.company }}
                                <span class="experience__location">{{ .Params.location }}</span>
                            </div>
                        </div>
                        <div class="experience__description d-none d-print-block">
                            <h1>{{ .Params.title }}</h1>
                            {{ .Content | safeHTML | transform.Plainify }}
                        </div>
                    </div>
                </a>
            </div>
            {{ end }}
            {{ else }}
            <p class="text-muted">No experience items to display.</p>
            {{ end }}
            {{ else }}
            <p class="text-muted">Experience information will be added soon.</p>
            {{ end }}

            {{/* 移除了View All按钮代码 */}}
        </div>
        <div class="experience-description col-12 col-md-6">
            {{ partial "experience-description.html" . }}
        </div>
    </div>
</section>