{{ define "main" }}
<section id="project"
         class="section section--border-bottom rad-animation-group flex-grow-1">
    <div id="main-content">
        <div class="row flex-column-reverse flex-md-row rad-fade-down">
            <div class="col-12 col-md-3 mt-3 mt-sm-0">
                {{ $baseLangSite := .Sites.Default }}
                {{ $currentPageID := .Page.File.UniqueID }}

                {{ $projects := (where .Site.RegularPages.ByDate.Reverse "Type" "project") }}
                {{ $projects = $projects | lang.Merge (where $baseLangSite.RegularPages.ByDate.Reverse "Type" "project") }}
                {{ range $projects }}
                <div class="project {{ if eq .Page.File.UniqueID $currentPageID }} selected {{ end }}">
                    <a href="{{.Permalink | relURL}}">
                        {{ $img := resources.Get .Params.companyLogo }}
                        {{ with $img }}
                        {{ $imgWebp := $img.Resize (printf "%dx%d webp q75 Lanczos picture" $img.Width $img.Height) }}
                        <div class="project__header  with-company-logo">
                            <img src="{{ $imgWebp.RelPermalink }}"
                                 alt="{{ .Params.company }} logo"
                                 class="project__company-logo"
                                 loading="lazy">
                            {{ else }}
                            <div class="project__header  no-company-logo">
                                {{ end }}
                                <div class="project__meta">
                                    <div class="project__title">{{ .Params.projectTitle }}</div>
                                    <div class="project__company">{{ .Params.duration }}</div>
                                </div>
                            </div>
                    </a>
                </div>
                {{ end }}
            </div>
            <div class="col-12 col-md-9 mt-9 mt-sm-0">
                <!-- 视频调试信息 -->
                <div style="background: #e7f3ff; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                    <h4>视频路径调试</h4>
                    <p><strong>原始路径:</strong> {{ .Params.video }}</p>
                    <p><strong>absURL 路径:</strong> {{ .Params.video | absURL }}</p>
                    <p><strong>relURL 路径:</strong> {{ .Params.video | relURL }}</p>
                </div>

                {{ if .Params.video }}
                <div class="project-video mb-4" style="border: 3px solid #28a745; padding: 10px; background: #f8f9fa;">
                    <h3>项目视频</h3>

                    <!-- 方案1: 使用 absURL -->
                    <video controls width="100%" style="max-width: 800px; background: #000;" id="project-video-abs">
                        <source src="{{ .Params.video | absURL }}" type="video/mp4">
                        您的浏览器不支持 HTML5 视频标签。
                    </video>

                    <div style="margin-top: 20px; text-align: center;">
                        <p>如果上方视频无法播放，尝试：</p>
                        <a href="{{ .Params.video | absURL }}" class="btn btn-primary" target="_blank">
                            在新标签页中打开视频
                        </a>
                        <a href="{{ .Params.video | absURL }}" download class="btn btn-secondary">
                            下载视频文件
                        </a>
                    </div>
                </div>
                {{ else }}
                <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 8px;">
                    <p>⚠️ 未配置项目视频</p>
                </div>
                {{ end }}

                <h1>{{ .Params.projectTitle }}</h1>
                <p class="lead">{{ .Description }}</p>

                {{ .Content | safeHTML }}
            </div>
        </div>
    </div>
</section>

<!-- 视频加载状态检查 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const video = document.getElementById('project-video-abs');

  if (video) {
    console.log('视频元素找到:', video);
    console.log('视频源:', video.querySelector('source').src);

    video.addEventListener('error', function(e) {
      console.error('视频加载错误:', e);
      console.error('错误代码:', video.error.code);
      console.error('错误信息:', video.error.message);

      // 显示错误信息给用户
      const errorDiv = document.createElement('div');
      errorDiv.style.background = '#f8d7da';
      errorDiv.style.color = '#721c24';
      errorDiv.style.padding = '10px';
      errorDiv.style.margin = '10px 0';
      errorDiv.style.borderRadius = '4px';
      errorDiv.innerHTML = `
        <strong>视频加载失败</strong><br>
        错误代码: ${video.error.code}<br>
        请 <a href="${video.querySelector('source').src}" target="_blank">点击这里</a> 尝试在新窗口打开视频
      `;
      video.parentNode.insertBefore(errorDiv, video.nextSibling);
    });

    video.addEventListener('loadeddata', function() {
      console.log('视频加载成功');
    });

    // 尝试加载视频
    video.load();
  }
});
</script>
{{ end }}